<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <title>Excel Report</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body { background: #f7f7fb; }
    .card { border-radius: 14px; }
    .muted { color: #6c757d; }
  </style>
</head>

<body>
  <div class="container my-4">

    <div class="d-flex align-items-start justify-content-between mb-3">
      <div>
        <h1 class="h3 mb-1">Excel Dashboard</h1>
        <div class="muted small">File: {{ file_name }} | Run: {{ run_time }}</div>
        {% if sampling_note %}
          <div class="text-warning small mt-1">{{ sampling_note }}</div>
        {% endif %}
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="muted small">Rows</div>
            <div class="h4 mb-0">{{ kpis.rows }}</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="muted small">Columns</div>
            <div class="h4 mb-0">{{ kpis.cols }}</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="muted small">Missing cells</div>
            <div class="h4 mb-0">{{ kpis.missing_total }}</div>
            <div class="muted small">{{ kpis.missing_pct }}%</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="muted small">Duplicate rows</div>
            <div class="h4 mb-0">{{ kpis.dup_rows }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="fw-semibold mb-2">Missing by column (Top 10)</div>
            <div style="height:320px;">
              <canvas id="chartTopMissing"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="fw-semibold mb-2">Column type distribution</div>
            <div style="height:320px;">
              <canvas id="chartTypeDist"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="fw-semibold">Preview (first 15 rows)</div>
          <div class="muted small">Showing up to 20 columns</div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead>
              <tr>
                {% for c in preview_cols %}
                  <th class="text-nowrap">{{ c }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for r in preview_rows %}
                <tr>
                  {% for c in preview_cols %}
                    <td class="text-nowrap">{{ r.get(c, "") }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="fw-semibold mb-2">Top issues</div>

        {% if top_issues and top_issues|length > 0 %}
          <ul class="mb-0">
            {% for it in top_issues %}
              <li>{{ it }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="muted">No issues detected.</div>
        {% endif %}
      </div>
    </div>

    <p class="muted small">
      For full details, check the generated report.xlsx file.
    </p>

  </div>
  <script id="charts-data" type="application/json">
  {{ charts | tojson }}
</script>
  <script>
    
  // charts objesini tek sefer tanimla (sayfa iki kez render edilse bile patlamaz)
  const charts = window.__charts || JSON.parse(
    document.getElementById("charts-data")?.textContent || "{}"
  );
  window.__charts = charts;

  function shortLabel(s) {
    if (!s) return "";
    if (s.length <= 22) return s;
    return s.slice(0, 22) + "...";
  }

  function getCanvas(id) {
    return document.getElementById(id);
  }

  // 1) Top missing (horizontal bar)
  (function () {
    const c = getCanvas("chartTopMissing");
    if (!c || !charts || !charts.top_missing) return;

    new Chart(c, {
      type: "bar",
      data: {
        labels: (charts.top_missing.labels || []).map(shortLabel),
        datasets: [{
          label: "Missing %",
          data: charts.top_missing.values || []
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: "y",
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: function(items) {
                const i = items && items.length ? items[0].dataIndex : 0;
                const full = (charts.top_missing.labels || [])[i] || "";
                return full;
              },
              label: function(item) {
                const v = item.parsed.x;
                return " " + v + "%";
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: { callback: function(v) { return v + "%"; } }
          },
          y: { ticks: { autoSkip: false } }
        }
      }
    });
  })();

  // 2) Type distribution (doughnut)
  (function () {
    const c = getCanvas("chartTypeDist");
    if (!c || !charts || !charts.type_dist) return;

    new Chart(c, {
      type: "doughnut",
      data: {
        labels: charts.type_dist.labels || [],
        datasets: [{
          label: "Count",
          data: charts.type_dist.values || []
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: "bottom" } }
      }
    });
  })();
</script>

</body>
</html>
